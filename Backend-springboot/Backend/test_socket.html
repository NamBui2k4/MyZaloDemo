<!DOCTYPE html>
<html lang="vi">
<head>
    <title>Chat STOMP Tester</title>
    <meta charset="UTF-8">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
    <!-- Development version -->
    <script src="https://unpkg.com/@popperjs/core@2/dist/umd/popper.js"></script>

    <!-- Production version -->
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <style>
        body { font-family: monospace; padding: 20px; }
        .box { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
        button { cursor: pointer; padding: 5px 10px; }
        #log { background: #f0f0f0; border: 1px solid #999; height: 300px; overflow: auto; padding: 10px; }
    </style>
</head>
<body>

<h2>üõ†Ô∏è C√¥ng c·ª• Test Socket Chat</h2>

<div class="box">
    <h3>1. K·∫øt n·ªëi</h3>
    <label>URL:</label>
    <input type="text" id="url" value="ws://localhost:8080/ws" size="50">
    <button onclick="connect()">üîå Connect</button>
    <button onclick="disconnect()" disabled id="btnDisconnect">‚ùå Disconnect</button>
    <div id="status" style="margin-top:5px; color:red">Status: Disconnected</div>
</div>

<div class="box">
    <h3>2. G·ª≠i tr·∫°ng th√°i (Client -> Server)</h3>
    <label>Destination:</label>
    <input type="text" id="destination" value="/app/message.delivered"><br><br>
    <label>JSON Body:</label><br>
    <textarea id="jsonBody" rows="5" cols="50">
{
  "messageId": 123,
  "conversationId": 1,
  "status": "DELIVERED"
}</textarea><br>
    <button onclick="send()" id="btnSend" disabled>üì§ G·ª≠i (Send)</button>
</div>

<div class="box">
    <h3>3. Log (Server ph·∫£n h·ªìi)</h3>
    <div id="log"></div>
</div>

<script>
    var stompClient = null;

    function log(message) {
        var logDiv = document.getElementById('log');
        var p = document.createElement('p');
        p.style.wordWrap = 'break-word';
        p.appendChild(document.createTextNode(message));
        logDiv.appendChild(p);
        logDiv.scrollTop = logDiv.scrollHeight;
    }

    function connect() {
        var url = document.getElementById('url').value;
        // V√¨ b·∫°n ƒë√£ t·∫Øt SockJS trong config Java, ta d√πng Stomp.client(url) tr·ª±c ti·∫øp
        stompClient = Stomp.client(url);

        log("dang ket noi den " + url + "...");

        stompClient.connect({}, function (frame) {
            document.getElementById('status').innerHTML = 'Status: Connected ‚úÖ';
            document.getElementById('status').style.color = 'green';
            document.getElementById('btnDisconnect').disabled = false;
            document.getElementById('btnSend').disabled = false;

            log('Connected: ' + frame);

            // T·ª∞ ƒê·ªòNG SUBSCRIBE v√†o queue status ƒë·ªÉ nghe ph·∫£n h·ªìi
            // L∆∞u √Ω: N·∫øu c√≥ Security, b·∫°n c·∫ßn login.
            // N·∫øu test local kh√¥ng authen, Server n√™n g·ª≠i v·ªÅ /topic/public-status ƒë·ªÉ d·ªÖ test
            stompClient.subscribe('/user/queue/status', function (greeting) {
                log('üì© NH·∫¨N ƒê∆Ø·ª¢C PH·∫¢N H·ªíI: ' + greeting.body);
            });

            // Subscribe th√™m topic l·ªói ƒë·ªÉ debug
            stompClient.subscribe('/user/queue/errors', function (msg) {
                log('‚ùå ERROR: ' + msg.body);
            });

        }, function (error) {
            log('‚ùå L·ªói k·∫øt n·ªëi: ' + error);
        });
    }

    function disconnect() {
        if (stompClient !== null) {
            stompClient.disconnect();
        }
        document.getElementById('status').innerHTML = 'Status: Disconnected';
        document.getElementById('status').style.color = 'red';
        document.getElementById('btnDisconnect').disabled = true;
        document.getElementById('btnSend').disabled = true;
        log("Disconnected");
    }

    function send() {
        var destination = document.getElementById('destination').value;
        var body = document.getElementById('jsonBody').value;

        try {
            stompClient.send(destination, {}, body);
            log("‚¨ÜÔ∏è ƒê√£ g·ª≠i t·ªõi " + destination + ": " + body);
        } catch (e) {
            log("‚ùå L·ªói g·ª≠i tin: " + e);
        }
    }
</script>
</body>
</html>